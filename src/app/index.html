<!DOCTYPE HTML>
<html>
<head>
 <meta charset="UTF-8">
 <title>Title</title>
 <script src="vendor/jquery/dist/jquery.js"></script>
 <script src="vendor/underscore/underscore.js"></script>
 <script src="vendor/backbone/backbone.js"></script>
 <script src="vendor/bootstrap/dist/js/bootstrap.js"></script>
 <link rel="stylesheet" href="vendor/bootstrap/dist/css/bootstrap.css">
 <link href="css/simple-sidebar/simple-sidebar.css" rel="stylesheet">
 <style type="text/css">
    body {
        padding: 50px 100px 50px 50px;
        background-image: url("img/background_green.jpg");
        background-attachment: fixed;
    }

    body.modal-open .blurred-background {
    -webkit-filter: blur(4px);
    -moz-filter: blur(4px);
    -o-filter: blur(4px);
    -ms-filter: blur(4px);
    filter: blur(4px);
    }

     .col-sm-3 {
         /* border: 1px solid; */
         height: 220px;
     }

     .poster {
         box-shadow: 10px 10px 5px black;
     }

     .poster:active {
         margin-top: 10px;
         margin-left: 10px;
         /* height: 160px;
         width: 106px; */
         box-shadow: 0px 0px 0px black;
     }

 </style>
</head>
<body>

<div w3-include-HTML="EditMovieModal.html">My HTML include will go here.</div>

<div id="wrapper" class="blurred-background">
            <!-- Sidebar -->
        <div id="sidebar-wrapper">
            <ul class="sidebar-nav">
                <li>
                    <a href="#">Movies</a>
                </li>
                <li>
                    <a href="#">TvShow</a>
                </li>
            </ul>
        </div>
        <!-- /#sidebar-wrapper -->
        <div id="page-content-wrapper">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-lg-12">
                            <div id="movielist">
                            </div>
                    </div>
                </div>
            </div>
    </div>
</div>
<script>

function writeMovieList(movieListJSON) {

    var i=1;
    var strHTML="";
    var thumbURI;
    //strHTML = "Total movies:" + movieListJSON.result.limits.total + "<br/>";
    var movieListDetails = movieListJSON.result.movies;
    $.each(movieListDetails, function(idMovie, movieDetails) {
        if (i == 1) {strHTML += '<div class="row">'};
        strHTML += '<div class="col-sm-3 col-md-3">';
        thumbURI = decodeURIComponent(movieDetails.thumbnail.substring(8,movieDetails.thumbnail.length-1));
        if (!(thumbURI.startsWith("http"))) {thumbURI = serverKodi + "vfs/" + thumbURI};

        /* strHTML += '<div class="thumbnail"><img src="' + thumbURI + '" height="50%" width="50%">';
        strHTML += '<div class="caption"><p class="text-center">' + movieDetails.label + '</p>';
        strHTML += '<p class="text-center"><button type="button" class="btn btn-info">Info</button></p></div></div></div>'; */

        strHTML += '<img class="poster" data-toggle="modal" data-target="#EditMovieModal" data-movieid="' + movieDetails.movieid + '" data-movietitle="' +  movieDetails.label + '" Title src="' + thumbURI + '" width="126px" height="180px"></div>'
        i++;
        if (i==5) {
          strHTML += '</div>';
          i = 1;
        };
    });

    document.getElementById('movielist').innerHTML = strHTML;

}

// Code to fecth JSON from server - Disabled for development / testing
    var serverKodi = "http://gverni3:8890/";
//    var serverKodi = "http://192.168.0.203/";
    var urlJsonRPC = "jsonrpc?request=";
    var stringJson = '{"jsonrpc": "2.0", "method": "VideoLibrary.GetMovies", "params": { "filter": {"field": "playcount", "operator": "is", "value": "0"}, "limits": { "start" : 0, "end": 25 }, "properties" : ["art", "rating", "thumbnail", "playcount", "file"], "sort": { "order": "ascending", "method": "label", "ignorearticle": true } }, "id": "libMovies"}';

// Settings for development
/*  var serverKodi = "../../test_files/";
    var urlJsonRPC = "";
    var stringJson = "videolibrary.getmovies_resp.json";
*/

    var urlKodi = serverKodi + urlJsonRPC + stringJson;

    $.getJSON(urlKodi, jQuery.noop)
    .error(function() { alert("Error reading JSON"); })
    .success(function(data) {
       writeMovieList(data);
    });

</script>
<script>

// Scripts for EditMovieModalvar 

var objMovieDetailsModal; 
    
$('#EditMovieModal').on('show.bs.modal', function (event) {
  var trigger = $(event.relatedTarget);
  var movieTitle = trigger.data('movietitle');
  var movieId = trigger.data('movieid');
  var jsonGetMovieDetail = `{"jsonrpc": "2.0", "method": "VideoLibrary.GetMovieDetails", "params": { "movieid": ${movieId} ,  "properties": ["title", "genre", "year", "rating", "director", "trailer", "tagline", "originaltitle", "lastplayed", "playcount", "writer", "studio", "mpaa", "country", "imdbnumber", "runtime", "set", "showlink", "top250", "votes", "thumbnail", "file", "sorttitle", "setid", "dateadded", "tag"] }, "id": "MovieDetail"}`;
  $.getJSON(serverKodi + urlJsonRPC + jsonGetMovieDetail, jQuery.noop)
  .error(function() { alert("Error reading JSON"); })
  .success(function(data) {
    $('.modal-title').text('Title: ' + movieTitle);
    objMovieDetailsModal = data.result.moviedetails; 
    $.each(objMovieDetailsModal, function(label, value) {
        $('#ModalMovieForm').append("<div class='form-group''><label for='frm" + label + "'>" + label + "</label><input name='frm" + label + "' class='form-control' type='text' value='" + value + "'></div>");     
    })
  });
});

$('#EditMovieModal').on('hidden.bs.modal', function (event) {
    //Reset form    
    $('#ModalMovieForm').html("") 
});

function saveMovieChanges() {
    //Create object from form 
    var objFromForm = {}; 
    //objFromForm.add("dateadded": "bla bla"); 
    //Iterate through $("#ModalMovieForm")[0][i] for the legth of the array  Iterate through $("#ModalMovieForm")[0].length
    // For each element create an object using key as $("#ModalMovieForm")[0][i].name and value $("#ModalMovieForm")[0][i].value
    //Compare object created with objMovieDetailsModal and extract only value that have changed
    //Update only value changed
    alert ("Saving movies"); 
}
    
</script>
<script>
(function () {

myHTMLInclude();

function myHTMLInclude() {
  var z, i, a, file, xhttp;
  z = document.getElementsByTagName("*");
  for (i = 0; i < z.length; i++) {
    if (z[i].getAttribute("include-html")) {
      a = z[i].cloneNode(false);
      file = z[i].getAttribute("include-html");
      var xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function() {
          a.removeAttribute("include-html");
          a.innerHTML = xhttp.responseText;
          z[i].parentNode.replaceChild(a, z[i]);
          myHTMLInclude();
      }      
      xhttp.open("GET", file, true);
      xhttp.send();
      return;
    }
  }
}

})();    
</script>
</body>
</html>
